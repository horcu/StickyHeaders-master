{"Id":"3e1a52bf-b06d-45a1-b515-03cebe8c81c6","Topic":"Ch 15. Threads and Locks","Question":"","Solution":"package Q15_04_Deadlock_Free_Class;\r\n\r\nimport java.util.ArrayList;\r\nimport java.util.HashMap;\r\nimport java.util.concurrent.locks.Lock;\r\nimport java.util.concurrent.locks.ReentrantLock;\r\n\r\npublic class LockNode {\r\n\tpublic enum VisitState {\r\n\t\tFRESH, VISITING, VISITED\r\n\t};\r\n\t\r\n\tprivate ArrayList<LockNode> children;\r\n\tprivate int lockId;\r\n\tprivate Lock lock;\r\n\tprivate int maxLocks;\r\n\t\r\n\tpublic LockNode(int id, int max) {\r\n\t\tlockId = id;\r\n\t\tchildren = new ArrayList<LockNode>();\r\n\t\tmaxLocks = max;\r\n\t}\r\n\t\r\n\t/* Join \"this\" to \"node\", checking to make sure that it doesn't create a cycle */\r\n\tpublic void joinTo(LockNode node) {\r\n\t\tchildren.add(node);\r\n\t}\r\n\t\r\n\tpublic void remove(LockNode node) {\r\n\t\tchildren.remove(node);\r\n\t}\r\n\t\r\n\t/* Check for a cycle by doing a depth-first-search. */\t\r\n\tpublic boolean hasCycle(HashMap<Integer, Boolean> touchedNodes) {\r\n\t\tVisitState[] visited = new VisitState[maxLocks];\r\n\t\tfor (int i = 0; i < maxLocks; i++) {\r\n\t\t\tvisited[i] = VisitState.FRESH;\r\n\t\t}\r\n\t\treturn hasCycle(visited, touchedNodes);\r\n\t}\r\n\t\r\n\tprivate boolean hasCycle(VisitState[] visited, HashMap<Integer, Boolean> touchedNodes) {\r\n\t\tif (touchedNodes.containsKey(lockId)) {\r\n\t\t\ttouchedNodes.put(lockId, true); \r\n\t\t}\r\n\t\t\r\n\t\tif (visited[lockId] == VisitState.VISITING) {\r\n\t\t\treturn true;\r\n\t\t} else if (visited[lockId] == VisitState.FRESH) {\r\n\t\t\tvisited[lockId] = VisitState.VISITING;\r\n\t\t\tfor (LockNode n : children) {\r\n\t\t\t\tif (n.hasCycle(visited, touchedNodes)) {\r\n\t\t\t\t\treturn true;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tvisited[lockId] = VisitState.VISITED;\r\n\t\t}\r\n\t\treturn false;\r\n\t}\r\n\t\r\n\tpublic Lock getLock() {\r\n\t\tif (lock == null) {\r\n\t\t\tlock = new ReentrantLock();\r\n\t\t}\r\n\t\treturn lock;\r\n\t}\r\n\t\r\n\tpublic int getId() {\r\n\t\treturn lockId;\r\n\t}\r\n}\r\n","Chapter":"Ch 15. Threads and Locks"}